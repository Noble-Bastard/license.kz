#!/bin/bash

echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð±ÐµÐ· Docker Compose (Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð±)..."

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
docker stop license_kz_app 2>/dev/null || true
docker rm license_kz_app 2>/dev/null || true

# Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð·
echo "ðŸ³ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Docker Ð¾Ð±Ñ€Ð°Ð·..."
docker build -t license-kz-app . --no-cache

if [ $? -ne 0 ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ±Ð¾Ñ€ÐºÐµ Ð¾Ð±Ñ€Ð°Ð·Ð°."
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
if [ ! -f ".env" ]; then
    echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»..."
    cat > .env << 'EOF'
APP_NAME=UPPERLICENSE
APP_ENV=production
APP_KEY=base64:PLACEHOLDER_KEY_REPLACE_ME
APP_DEBUG=false
APP_URL=http://license.kz:8001

DB_CONNECTION=mysql
DB_HOST=localhost
DB_PORT=3306
DB_DATABASE=license_kz
DB_USERNAME=root
DB_PASSWORD=

CACHE_DRIVER=file
SESSION_DRIVER=file
QUEUE_CONNECTION=sync
RUN_MIGRATIONS=false
EOF
fi

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€..."
docker run -d \
  --name license_kz_app \
  --network host \
  -p 8001:80 \
  -v "$(pwd)/storage:/var/www/html/storage" \
  -v "$(pwd)/public/uploads:/var/www/html/public/uploads" \
  -v "$(pwd)/.env:/var/www/html/.env" \
  --restart unless-stopped \
  license-kz-app

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°..."
sleep 5
docker ps | grep license_kz_app

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð¸
echo "ðŸ“ Ð›Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°:"
docker logs license_kz_app --tail=20

echo ""
echo "âœ… ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
echo "ðŸŒ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ: curl http://localhost:8001"
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: docker ps | grep license_kz_app"
echo "ðŸ“ Ð›Ð¾Ð³Ð¸: docker logs license_kz_app -f"
echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ: docker stop license_kz_app"

